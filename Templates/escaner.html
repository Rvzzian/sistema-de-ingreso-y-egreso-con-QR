<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Escáner de Asistencia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            background: #000;
            color: white;
        }

        #reader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        #mensaje {
            min-height: 150px;
        }

        .btn-activar {
            font-size: 1.5rem;
            padding: 2rem;
        }
    </style>
</head>

<body class="d-flex flex-column h-100">

    <!-- Pantalla inicial: botón grande para activar cámara -->
    <div id="pantalla-inicio" class="flex-grow-1 d-flex align-items-center justify-content-center">
        <button id="btn-activar-camara" class="btn btn-success btn-lg btn-activar rounded-pill shadow-lg">
            <i class="bi bi-camera-fill fs-1"></i><br><br>
            <strong>TOQUE AQUÍ PARA ACTIVAR LA CÁMARA</strong><br>
            <small>y comenzar a escanear QR</small>
        </button>
    </div>

    <!-- Pantalla de escaneo (oculta al inicio) -->
    <div id="pantalla-escaner" class="d-none flex-column h-100">
        <div class="text-center py-4 bg-dark">
            <h1 class="display-6">Escanee su QR</h1>
        </div>

        <div id="reader" class="flex-grow-1"></div>

        <div id="mensaje" class="text-center py-5 bg-dark">
            <h1 id="titulo" class="display-3"></h1>
            <p id="detalle" class="lead fs-3"></p>
        </div>
    </div>

<script>
    const pantallaInicio = document.getElementById('pantalla-inicio');
    const pantallaEscanner = document.getElementById('pantalla-escaner');
    const btnActivar = document.getElementById('btn-activar-camara');
    const titulo = document.getElementById('titulo');
    const detalle = document.getElementById('detalle');
    const reader = document.getElementById('reader');

    let html5QrCode = null;

    btnActivar.onclick = () => {
        pantallaInicio.classList.add('d-none');
        pantallaEscanner.classList.remove('d-none');
        iniciarEscanner();
    };

    function iniciarEscanner() {
        // Limpiar vista anterior si existe
        reader.innerHTML = '';

        html5QrCode = new Html5Qrcode("reader");

        const config = {
            fps: 10,
            qrbox: { width: 350, height: 350 },
            aspectRatio: 1.0
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
                const match = decodedText.match(/trabajador\/(\d+)$/);
                if (!match) {
                    mostrarMensaje("QR inválido", "Intente de nuevo", "text-danger");
                    setTimeout(iniciarEscanner, 3000);
                    return;
                }

                const id = match[1];

                fetch(`/trabajador/${id}?escaner=1`)
                    .then(r => r.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const tituloMsg = doc.querySelector('h1')?.innerText.trim() || '¡Registrado!';
                        const nombre = doc.querySelector('h2')?.innerText || '';
                        const info = doc.querySelector('p.lead')?.innerText || '';

                        let clase = "text-success";
                        if (tituloMsg.includes("SALIDA")) clase = "text-warning";

                        mostrarMensaje(tituloMsg, `${nombre}<br><small>${info}</small>`, clase);
                    })
                    .catch(() => {
                        mostrarMensaje("Error", "No se pudo registrar", "text-danger");
                    });

                // Detener cámara y reiniciar después de 5 segundos
                html5QrCode.stop().then(() => {
                    setTimeout(iniciarEscanner, 5000);
                });
            },
            (error) => {
                // Ignorar errores normales de escaneo
            }
        ).catch(err => {
            console.error("Error al iniciar cámara:", err);
            mostrarMensaje("Error de cámara", "Recargue la página e intente de nuevo.", "text-danger");
            setTimeout(() => {
                pantallaEscanner.classList.add('d-none');
                pantallaInicio.classList.remove('d-none');
            }, 4000);
        });
    }

    function mostrarMensaje(tituloMsg, texto, clase = "text-success") {
        titulo.innerHTML = tituloMsg;
        titulo.className = `display-3 ${clase}`;
        detalle.innerHTML = texto;

        setTimeout(() => {
            titulo.innerHTML = "";
            detalle.innerHTML = "";
        }, 5000);
    }
</script>
</body>

</html>